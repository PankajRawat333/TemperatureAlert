SELECT
    t1.*,t3.EventProcessedUtcTime as LastAlertTime
    ,(CASE WHEN t3.EventProcessedUtcTime != null THEN DATEDIFF(minute, t1.EventProcessedUtcTime,t3.EventProcessedUtcTime) ELSE 11 END) as Test
INTO
    [alertOutputsb]
FROM
    [tsfInput] t1
    INNER JOIN [device-threashold-Input] t2
ON t1.DeviceId = t2.DeviceId
    LEFT OUTER JOIN [temperature-alerts-Input] t3
ON t1.DeviceId = t3.DeviceId   
    WHERE t1.Temperature >= Cast(t2.ThresholdLimit as float) 
    AND (CASE WHEN t3.EventProcessedUtcTime != null THEN DATEDIFF(minute, t1.MESSAGETIME,t3.EventProcessedUtcTime) ELSE 11 END) > 10
    AND ISFIRST(mi, 5) OVER (PARTITION BY t1.DeviceId) = 1